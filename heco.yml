version: "3.4"
services:
  heco:
    restart: "${RESTART}"
    build:
      context: ./geth
      dockerfile: Dockerfile.heco
      args:
        - BUILD_TARGET=${GETH_SRC_BUILD_TARGET}
    stop_grace_period: 3m
    image: heco:local
    volumes:
      - heco-ec-data:/data/heco/data
      - /etc/localtime:/etc/localtime:ro
    ports:
      - 32668:32668/tcp
      - 32668:32668/udp
    expose:
      - 8545/tcp
      - 8546/tcp
    entrypoint:
      - geth
      - --config
      - /data/heco/data/config.toml
      #- --ws.origins="*"
    labels:
      - traefik.enable=true
      - traefik.http.routers.heco.service=heco
      - traefik.http.routers.heco.entrypoints=websecure
      - traefik.http.routers.heco.rule=Host(`${EL_HOST}.${DOMAIN}`)
      - traefik.http.routers.heco.tls.certresolver=letsencrypt
      - traefik.http.routers.hecolb.service=heco
      - traefik.http.routers.hecolb.entrypoints=websecure
      - traefik.http.routers.hecolb.rule=Host(`${EL_LB}.${DOMAIN}`)
      - traefik.http.routers.hecolb.tls.certresolver=letsencrypt
      - traefik.http.services.heco.loadbalancer.server.port=8545
      - traefik.http.routers.hecows.service=hecows
      - traefik.http.routers.hecows.entrypoints=websecure
      - traefik.http.routers.hecows.rule=Host(`${EL_WS_HOST}.${DOMAIN}`)
      - traefik.http.routers.hecows.tls.certresolver=letsencrypt
      - traefik.http.routers.hecowslb.service=hecows
      - traefik.http.routers.hecowslb.entrypoints=websecure
      - traefik.http.routers.hecowslb.rule=Host(`${EL_WS_LB}.${DOMAIN}`)
      - traefik.http.routers.hecowslb.tls.certresolver=letsencrypt
      - traefik.http.services.hecows.loadbalancer.server.port=8546

  eth:
    image: tianon/true
    depends_on:
      - heco

volumes:
  heco-ec-data:
