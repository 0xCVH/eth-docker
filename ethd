#!/bin/bash
set -euo pipefail

cmd() {
    docker-compose "$@"
}

update() {
    if git branch | grep -q master; then
      git branch -m master main
      git fetch origin
      git branch -u origin/main main
      git remote set-head origin -a
    fi
    git pull
    cmd build --pull
    cmd pull 2>/dev/null || true
    envmigrate
}

upgrade() {
  update
}

start() {
    cmd up -d eth
}

up() {
    start
}

stop() {
    cmd down --remove-orphans
}

down() {
    stop
}

restart() {
    stop
    start
}

logs() {
    cmd logs "$@"
}

envmigrate() {
    if [ ! -f ./.env ]; then
        return
    fi
    ALL_VARS=( COMPOSE_FILE EC_NODE EC_FALLBACK_NODE1 EC_FALLBACK_NODE2 GRAFFITI NETWORK EC_NETWORK \
             PRYSM_PEER_COUNT LH_PEER_COUNT TEKU_PEER_COUNT NIM_PEER_COUNT DOMAIN ACME_EMAIL \
             CF_EMAIL CF_API_TOKEN AWS_PROFILE AWS_HOSTED_ZONE_ID GRAFANA_HOST PRYSM_HOST \
             EC_HOST EC_WS_HOST DDNS_SUBDOMAIN DDNS_PROXY TEKU_RAPID_SYNC CC_NODE BEACON_STATS_API \
             EC_P2P_PORT LH_PORT PRYSM_PORT PRYSM_UDP_PORT NIM_PORT TEKU_PORT GRAFANA_PORT \
             PRYSM_WEB_PORT TRAEFIK_WEB_PORT TRAEFIK_WEB_HTTP_PORT EC_RPC_PORT EC_WS_PORT \
             RESTART LOG_LEVEL )
    OLD_VARS=( ETH1_NODE ETH1_FALLBACK_NODE1 ETH1_FALLBACK_NODE2 ETH1_NETWORK ETH1_HOST \
             ETH1_WS_HOST BN_NODE ETH1_PORT ETH1_RPC_PORT ETH1_WS_PORT )
    NEW_VARS=( EC_NODE EC_FALLBACK_NODE1 EC_FALLBACK_NODE2 EC_NETWORK EC_HOST \
             EC_WS_HOST CC_NODE EC_P2P_PORT EC_RPC_PORT EC_WS_PORT )

    cp .env .env.bak
    cp default.env .env
    cp .env.bak .env.source
    # Special-case TEKU_RAPID_SYNC
    if grep -qF "TEKU_RAPID_SYNC" .env.source 2>/dev/null ; then
        sed -i "s~^\(TEKU_RAPID_SYNC\s*=\s*\)\(.*\)$~\1\"\2\"~" .env.source
    fi
    # Special-case GRAFFITI
    if grep -qF "GRAFFITI" .env.source 2>/dev/null ; then
        sed -i "s~^\(GRAFFITI\s*=\s*\)\(.*\)$~\1\"\2\"~" .env.source
    fi
    source .env.source 2>/dev/null || true
    rm .env.source
    # Migrate over user settings
    for var in "${ALL_VARS[@]}"; do
        if [ -n "${!var+set}" ]; then
            sed -i "s~^\(${var}\s*=\s*\).*$~\1${!var}~" .env
        fi
    done
    # Migrate from older-style naming
    for index in "${!OLD_VARS[@]}"; do
        if [ -n "${!OLD_VARS[index]+set}" ]; then
            sed -i "s~^\(${NEW_VARS[index]}\s*=\s*\).*$~\1${!OLD_VARS[index]}~" .env
        fi 
    done
    #special case http://eth1 and http://beacon
    sed -i "s/http:\/\/eth1/http:\/\/execution/g" .env
    sed -i "s/http:\/\/beacon/http:\/\/consensus/g" .env

    echo "Your .env configuration settings have been migrated to a fresh copy. You can \
find the original contents in .env.bak."
    echo "NB: If you made changes to the source or binary build targets, these have NOT \
been migrated, please recreate these changes yourself."
}

query_consensus_client() {
    CONSENSUS_CLIENT=$(whiptail --notags --title "Select consensus client" --menu \
    "Which consensus client do you want to run?" 15 60 7 \
    "teku-base.yml" "Teku" \
    "lh-base.yml" "Lighthouse" \
    "prysm-base.yml" "Prysm" \
    "nimbus-base.yml" "Nimbus" \
    "teku-validator.yml" "Teku validator client with Infura beacon" \
    "lh-validator.yml" "Lighthouse validator client with Infura beacon" 3>&1 1>&2 2>&3)

    # Ask the user
    exitstatus=$?
    if [ $exitstatus != 0 ]; then exit 0 ; fi

    echo "Your consensus client file is:" $CONSENSUS_CLIENT
}

query_custom_execution_client() {
        EC_CUSTOM_NODE=$(whiptail --title "Configure custom execution client" --inputbox "What is the URL for your custom execution client? (right-click to paste)" 10 60 https://goerli.infura.io/v3/... 3>&1 1>&2 2>&3)
        # Ask the user
        exitstatus=$?
        if [ $exitstatus = 0 ]; then
            echo "your custom execution client is:" $EC_CUSTOM_NODE
        else
            echo "You chose Cancel."
            exit 0
        fi
}

query_fallback_execution_client() {
        EC_FALLBACK_NODE=$(whiptail --title "Configure fallback execution client" --inputbox "What is the URL for your fallback execution client? (right-click to paste)" 10 60 https://goerli.infura.io/v3/... 3>&1 1>&2 2>&3)
        # Ask the user
        exitstatus=$?
        if [ $exitstatus = 0 ]; then
            echo "your fallback execution client is:" $EC_FALLBACK_NODE
        else
            echo "You chose Cancel."
            exit 0
        fi
}

query_execution_client() {
    EXECUTION_CLIENT=$(whiptail --notags --title "Select execution client" --menu \
    "Which execution client do you want to run?  Choose Custom for 3rd parties like Infura" 15 60 6 \
    "NONE" "Custom" \
    "geth.yml" "Geth" \
    "nm.yml" "Nethermind" \
    "besu.yml" "Besu" 3>&1 1>&2 2>&3)

    # Ask the user
    exitstatus=$?
    if [ $exitstatus != 0 ]; then exit 0 ; fi

    if [ "$EXECUTION_CLIENT" = "NONE" ]; then
        unset EXECUTION_CLIENT
        query_custom_execution_client
        EC_NODE=$EC_CUSTOM_NODE
    else
        echo "Your execution client file is:" $EXECUTION_CLIENT
        if [ "$CONSENSUS_CLIENT" == "nimbus-base.yml" ]; then
            EC_NODE="ws://execution:8546"
        else
            EC_NODE="http://execution:8545"
        fi 

        if (whiptail --title "Select Option" --yesno "Do you want to use a fallback execution client?" 10 60) then
            EC_FALLBACK=yes
        else
            EC_FALLBACK=no
        fi

        if [ $EC_FALLBACK = "yes" ]; then
            query_fallback_execution_client
            if [ "$CONSENSUS_CLIENT" == "prysm-base.yml" ]; then
                # Update The Value in env.
                if ! grep -qF "EC_FALLBACK_NODE1" $ENV_FILE 2>/dev/null ; then
                    echo "EC_FALLBACK_NODE1=${EC_FALLBACK_NODE}" >> $ENV_FILE
                fi
                sed -i "s~^\(EC_FALLBACK_NODE1\s*=\s*\).*$~\1${EC_FALLBACK_NODE}~" $ENV_FILE
            else
                EC_NODE="$EC_NODE"",""$EC_FALLBACK_NODE"
            fi
        fi
    fi
    # Update The Value in env.
    if ! grep -qF "EC_NODE" $ENV_FILE 2>/dev/null ; then
        echo "EC_NODE=${EC_NODE}" >> $ENV_FILE
    fi
    sed -i "s~^\(EC_NODE\s*=\s*\).*$~\1${EC_NODE}~" $ENV_FILE
}

query_grafana() {
    # Use Grafana
    if (whiptail --title "Select Option" --yesno "Do you want to use Grafana dashboards?" 10 60) then
        GRAFANA=yes
    else
        GRAFANA=no
    fi

    # Which Grafana should be used
    if [ $GRAFANA = "yes" ]; then
        GRAFANA_CLIENT=$(echo $(echo $CONSENSUS_CLIENT | cut -d '-' -f1)-grafana.yml:grafana-insecure.yml)
    else
        unset GRAFANA_CLIENT
    fi
}

query_infura_beacon() {
    CC_NODE=$(whiptail --title "Configure Infura beacon node" --inputbox "What is the URL for your Infura beacon? (right-click to paste)" 10 60 3>&1 1>&2 2>&3)
    # Ask the user
    exitstatus=$?
    if [ $exitstatus = 0 ]; then
        echo "your Infura beacon is:" $CC_NODE
    else
        echo "You chose Cancel."
        exit 0
    fi
}

config () {
    # Don't run as root
    if [[ $EUID -eq 0 ]]; then
        echo "Please run this as a non-root user." 
        exit 1
    fi

    # Don't run from another directory
    if ! [[ -f "ethd" ]]; then
        echo "Please run this from the eth-docker directory." 
        exit 1
    fi

    # Create ENV file if needed
    ENV_FILE=.env 

    if ! [[ -f "$ENV_FILE" ]]; then
        ENV_FILE_GUESS="$(eval realpath default.env)"
        ENV_TEMPLATE=$(whiptail --title "Configure ENV_FILE" --inputbox "No $ENV_FILE file found, press enter to use the default, or choose a backup" 10 60 $ENV_FILE_GUESS 3>&1 1>&2 2>&3)

        # Ask the user
        exitstatus=$?
        if [ $exitstatus = 0 ]; then
            echo "your ENV_TEMPLATE is:" $ENV_FILE
        else
            echo "You chose Cancel."
        fi

        # Update The Value in env.
        cp $ENV_TEMPLATE $ENV_FILE
    fi

    query_consensus_client

    if [[ "$CONSENSUS_CLIENT" != "teku-validator.yml" && "$CONSENSUS_CLIENT" != "lh-validator.yml" ]]; then
        CC_NODE="http://consensus:5052"

        query_execution_client
        query_grafana
    else
        unset EXECUTION_CLIENT
        unset GRAFANA_CLIENT

        query_infura_beacon
    fi

    # Update The Value in env.
    if ! grep -qF "CC_NODE" $ENV_FILE 2>/dev/null ; then
        echo "CC_NODE=${CC_NODE}" >> $ENV_FILE
    fi
    sed -i "s~^\(CC_NODE\s*=\s*\).*$~\1${CC_NODE}~" $ENV_FILE

    if [[ "$CONSENSUS_CLIENT" == "teku-base.yml" ]]; then
        # Use rapid sync
        if (whiptail --title "Select Option" --yesno "Do you want to use Teku rapid sync with Infura beacon?" 10 60) then
            RAPIDSYNC=yes
        else
            RAPIDSYNC=no
        fi
  
        if [ $RAPIDSYNC = "yes" ]; then
            query_infura_beacon
            CC_NODE="$CC_NODE/eth/v1/debug/beacon/states/finalized"
        else
            CC_NODE=""
        fi
    else
        CC_NODE=""
    fi

    # Update The Value in env.
    if ! grep -qF "TEKU_RAPID_SYNC" $ENV_FILE 2>/dev/null ; then
        echo "TEKU_RAPID_SYNC=${CC_NODE}" >> $ENV_FILE
    fi
    sed -i "s~^\(TEKU_RAPID_SYNC\s*=\s*\).*$~\1${CC_NODE}~" $ENV_FILE

    # COMPOSE_FILE

    # Guess COMPOSE_FILE
    COMPOSE_FILE_GUESS=$CONSENSUS_CLIENT
    if [ ${EXECUTION_CLIENT+x} ]; then
        COMPOSE_FILE_GUESS="$COMPOSE_FILE_GUESS:$EXECUTION_CLIENT"
    fi
    if [ ${GRAFANA_CLIENT+x} ]; then
        COMPOSE_FILE_GUESS="$COMPOSE_FILE_GUESS:$GRAFANA_CLIENT"
    fi

    if ! (whiptail --title "Does COMPOSE_FILE look good?" --yesno "$COMPOSE_FILE_GUESS" 10 60) then
        COMPOSE_FILE=$(whiptail --title "Configure COMPOSE_FILE" --inputbox "What is your COMPOSE_FILE?" 10 60 $COMPOSE_FILE_GUESS 3>&1 1>&2 2>&3)	
    else
        COMPOSE_FILE=${COMPOSE_FILE_GUESS}
    fi

    # Ask the user
    exitstatus=$?
    if [ $exitstatus = 0 ]; then
        echo "Your COMPOSE_FILE is:" $COMPOSE_FILE
    else
        echo "You chose Cancel."
        exit 0
    fi

    # Update The Value in env.
    if ! grep -qF "COMPOSE_FILE" $ENV_FILE 2>/dev/null ; then
        echo "COMPOSE_FILE=${COMPOSE_FILE}" >> $ENV_FILE
    fi
    sed -i "s/^\(COMPOSE_FILE\s*=\s*\).*$/\1${COMPOSE_FILE}/" $ENV_FILE

    if [[ "$CONSENSUS_CLIENT" != "teku-validator.yml" && "$CONSENSUS_CLIENT" != "lh-validator.yml" ]]; then
        # Mainnet or Testnet network

        NETWORK=$(whiptail --notags --title "Select Network" --menu \
        "Which network do you want to run on?" 15 60 3 \
        "prater" "Prater Testnet" \
        "mainnet" "Ethereum Mainnet" 3>&1 1>&2 2>&3)

        # Update The Value in env.
        if [ $NETWORK = "mainnet" ]; then
            sed -i "s/^\(NETWORK\s*=\s*\).*$/\1mainnet/" $ENV_FILE
            sed -i "s/^\(EC_NETWORK\s*=\s*\).*$/\1mainnet/" $ENV_FILE
            echo "You chose to run on Ethereum mainnet"
        elif [ $NETWORK = "prater" ]; then
            sed -i "s/^\(NETWORK\s*=\s*\).*$/\1prater/" $ENV_FILE
            sed -i "s/^\(EC_NETWORK\s*=\s*\).*$/\1goerli/" $ENV_FILE
            echo "You chose to run on Prater testnet"
        else
            echo "You chose Cancel."
            exit 0
        fi
    fi
}

printhelp() {
    me=$(basename $BASH_SOURCE)
    echo "usage: $me [help|-h|--help] <subcommand>"
    echo ""
    echo "optional arguments:"
    echo "  help | -h | --help"
    echo "    print this message and exit"
    echo ""
    echo "subcommands:"
    echo "  config "
    echo "     configures the tool with your choice of clients"
    echo "  update "
    echo "     updates all client versions, but notably does not update this tool itself"
    echo "  start"
    echo "     starts the node software"
    echo "  stop"
    echo "     stops the node software"
    echo "  restart"
    echo "     restarts the node software, a combination of stop and start"
    echo "  logs"
    echo "     shows logs"
    echo "  cmd <command>"
    echo "     executes arbitrary docker-compose command. use "help" help to list them"
    echo ""
    echo ""
    echo "The logs subcommand can be appended by flags and specify the container/s. example: "
    echo ""
    echo "  $me logs -f --tail 500 ec"
    echo "    shows logs only for ec service"
    echo ""
    echo ""
    echo "Be sure to run the config command as a non-root user, and all other commands"
    echo "either with sudo, or as a user who is part of the docker group"
    echo ""
    exit 0
}

if [[ "$#" -eq 0 || "$1" == "help" || "$1" == "-h" || "$1" == "--help" ]]; then
    printhelp
fi

command=${1}
shift

${command} $@
